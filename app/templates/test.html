<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>카톡 웹 - {{ room }}</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='lib/semantic/dist/semantic.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/macros.css') }}">
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.png') }}">

        <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" 
            integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous">
        </script>
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>

        <script type="text/javascript" charset="utf-8">
            var socket;
            

            $(document).ready(function(){                                
                var $comments = $('.comments');
                socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
                socket.on('connect', function() {
                    socket.emit('joined', {});
                });
                socket.on('status', function(data) {
                    var message = data.msg;

                    var $div = $(`<div class="ui log label"></div>`)
                        .text(message)
                    
                    $comments.append($div);
                });
                socket.on('message', function(data) {
                    var name = data.name;
                    var message = data.msg;
                    var Now = new Date();

                    if (Now.getHours > 12) {
                        var date = '오후 ' + Now.getHours()-12 
                            + ':' + Now.getMinutes();
                    }
                    else {
                        var date = '오전 ' + Now.getHours()
                            + ':' + Now.getMinutes();
                    }

                    var $name = $('<a class="author">').append(name);
                    var $date = $('<span class="date">').append(date);
                    var $metadata = $('<div class="metadata">').append($date);
                    var $name_date = $('<div>').append($name, $metadata);
                    
                    var $text = $('<div class="ui left pointing label text">')
                        .append(message);

                    
                    var $content = $('<div class="content">')
                        .append($name_date, $text);
                    var $image = $(`
                        <a class="avatar">
                            <img class="ui circular image" src="/static/images/default.png">
                        </a>
                    `);

                    var $comment = $(`
                        <div class="comment">
                    `).append($image, $content);                    
                    
                    $comments.append($comment);
                    $('.scrolling').scrollTop($('.scrolling')[0].scrollHeight);
                });

                $('#text').keypress(function(e) {
                    var code = e.keyCode || e.which;
                    if (code == 13) {
                        text = $('#text').val();
                        $('#text').val('');
                        socket.emit('text', {msg: text});
                        $('.scrolling').scrollTop($('.scrolling')[0].scrollHeight);
                    }
                });
                $('.scrolling').scrollTop($('.scrolling')[0].scrollHeight);
            });
            
            function leave_room() {
                socket.emit('left', {}, function() {
                    socket.disconnect();

                    window.location.href = "{{ url_for('index') }}";
                });
            }
        </script>
    </head>
    <body>
        <div class="chatting ui">
            <h3 class="ui header">
                <i class="angle left icon" onclick="leave_room();"></i>
                <div class="content name">
                    {{ me.nickName }}
                </div>
            </h3>
            <div class="middle">
                <div class="scrolling content" style="width: 341px;">
                    <div class="ui large comments">
                        <div class="ui log label">2020년 2월 11일 화요일</div>
                        
                    </div>
                </div>
            </div>
            <div class="footer">
                <table>
                    <thead>
                        <th><textarea class="input" id="text"></textarea></th>
                        <th><button type="submit" class="ui submit button">전송</button></t>
                    </thead>
                </table>
            </div>
        </div>
    </body>
</html>
